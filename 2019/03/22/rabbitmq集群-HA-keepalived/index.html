<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>rabbitmq集群+HA+keepalived | nice</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">rabbitmq集群+HA+keepalived</h1><a id="logo" href="/.">nice</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/guestbook/"><i class="fa fa-comments"> 留言</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">rabbitmq集群+HA+keepalived</h1><div class="post-meta">Mar 22, 2019</div><div class="post-content"><h2 id="rabbitmq集群"><a href="#rabbitmq集群" class="headerlink" title="rabbitmq集群"></a>rabbitmq集群</h2><h3 id="环境：centos7-3台rabbitmq集群-2台-haproxy代理-keepalived"><a href="#环境：centos7-3台rabbitmq集群-2台-haproxy代理-keepalived" class="headerlink" title="环境：centos7  3台rabbitmq集群+ 2台 haproxy代理+keepalived"></a>环境：centos7  3台rabbitmq集群+ 2台 haproxy代理+keepalived</h3><p>192.168.9.106 rabbitmq1 centos7</p>
<p>192.168.9.147 rabbitmq2 centos7</p>
<p>192.168.9.150 rabbitmq3 centos7</p>
<h4 id="所有服务器都安装rabbitmq"><a href="#所有服务器都安装rabbitmq" class="headerlink" title="所有服务器都安装rabbitmq"></a>所有服务器都安装rabbitmq</h4><blockquote>
<p>此处采用 rpm 包安装。 版本号为： 3.6.6</p>
</blockquote>
<ol>
<li><p>将所需要的<code>rpm包</code>: <a href="../pkg/rabbitmq/erlang-19.2.3-1.el6.x86_64.rpm">erlang</a>,<a href="../pkg/rabbitmq/rabbitmq-server-3.6.6-1.el6.noarch.rpm">rabbitmq-server</a> 放到 <code>/opt/</code> 下</p>
</li>
<li><p>安装<code>erlang</code>,<code>rabbitmq-server</code></p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/</span><br><span class="line">yum install -y erlang-19.2.3-1.el6.x86_64.rpm rabbitmq-server-3.6.6-1.el6.noarch.rpm</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>进行必要的配置</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设为开机启动</span></span><br><span class="line">systemctl start rabbitmq-server</span><br><span class="line">systemctl <span class="built_in">enable</span> rabbitmq-server</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装web界面</span></span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置</span></span><br><span class="line">rabbitmqctl add_user towatt towatt</span><br><span class="line">rabbitmqctl set_user_tags towatt administrator</span><br><span class="line">rabbitmqctl set_permissions -p <span class="string">"/"</span> towatt <span class="string">"."</span> <span class="string">"."</span> <span class="string">".*"</span></span><br><span class="line"></span><br><span class="line">镜像模式：把需要的队列做成镜像队列，存在于多个节点，属于RabbitMQ的HA方案</span><br><span class="line"></span><br><span class="line">该模式解决了上述问题，其实质和普通模式不同之处在于，消息实体会主动在镜像节点间同步，而不是在consumer取数据时临时拉取。该模式带来的副作用也很明显，除了降低系统性能外，如果镜像队列数量过多，加之大量的消息进入，集群内部的网络带宽将会被这种同步通讯大大消耗掉。所以在对可靠性要求较高的场合中适用，一个队列想做成镜像队列，需要先设置policy，然后客户端创建队列的时候，rabbitmq集群根据“队列名称”自动设置是普通集群模式或镜像队列。具体如下：</span><br><span class="line"></span><br><span class="line">队列通过策略来使能镜像。策略能在任何时刻改变，rabbitmq队列也近可能的将队列随着策略变化而变化；非镜像队列和镜像队列之间是有区别的，前者缺乏额外的镜像基础设施，没有任何slave，因此会运行得更快</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>集群配置<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 准备工作 三台机器配置主机名，添加到 /etc/hosts(三台机器都执行此操作)</span></span><br><span class="line">vim /etc/hosts</span><br><span class="line">192.168.9.106 rabbitmq1</span><br><span class="line">192.168.9.147 rabbitmq2</span><br><span class="line">192.168.9.150 rabbitmq3</span><br><span class="line"></span><br><span class="line"><span class="comment">## 1. 停止三个节点</span></span><br><span class="line">rabbitmqctl stop</span><br><span class="line"><span class="comment"># 2. 集群启动,三个节点都启动</span></span><br><span class="line">rabbitmq-server -detached</span><br><span class="line"><span class="comment"># 本实验选定9.106 rabbitmq1为主节点,复制9.106中的.erlang.cookie到9.147（rabbitmq2），9.150（rabbitmq3）上</span></span><br><span class="line"></span><br><span class="line">scp /var/lib/rabbitmq/.erlang.cookie root@rabbitmq2:/var/lib/rabbitmq/</span><br><span class="line">scp /var/lib/rabbitmq/.erlang.cookie root@rabbitmq3:/var/lib/rabbitmq/</span><br><span class="line"><span class="comment"># 3. rabbitmq2操作,rabbitmq3亦是如此</span></span><br><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl join_cluster rabbit@rabbitmq1</span><br><span class="line">rabbitmqctl start_app</span><br><span class="line"><span class="comment"># 4.退出集群</span></span><br><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl reset</span><br><span class="line">rabbitmqctl start_app</span><br><span class="line"><span class="comment"># 5.集群收缩</span></span><br><span class="line">rabbitmqctl forget_cluster_node rabbit@rabbitmq1</span><br><span class="line"><span class="comment"># 6. 集群名称修改</span></span><br><span class="line">rabbitmqctl set_cluster_name rabbit@rabbitmq1</span><br><span class="line"><span class="comment"># 7.查看集群状态</span></span><br><span class="line">rabbitmqctl cluster_status</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>5.登陆页面查看<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq1 http://192.168.9.106:15672</span><br><span class="line">rabbitmq2 http://192.168.9.143:15672</span><br><span class="line">rabbitmq3 http://192.168.9.150:15672</span><br><span class="line">登陆后 在node 界面会看到三个集群节点</span><br></pre></td></tr></table></figure></p>
<p>6.配置镜像模式<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">在任意一个节点上执行：</span><br><span class="line"></span><br><span class="line">1 我们在主节点运行 rabbitmqctl set_policy ha-all <span class="string">"^"</span> <span class="string">'&#123;"ha-mode":"all"&#125;'</span></span><br><span class="line"></span><br><span class="line">将所有队列设置为镜像队列，即队列会被复制到各个节点，各个节点状态保持一直。</span><br><span class="line"></span><br><span class="line">2 我们去rabbitmq2  rabbitmq3 上查看策略。</span><br><span class="line"></span><br><span class="line">rabbitmqctl list_policies <span class="comment">#查看策略</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Listing policies ...</span></span><br><span class="line"><span class="comment">#/	ha-all	all	^	&#123;"ha-mode":"all"&#125;	0</span></span><br></pre></td></tr></table></figure></p>
<h4 id="至此，rabbitmq镜像模式集群搭建完成，接下来-我们配置haproxy-keepalived-实现高可用和负载均衡"><a href="#至此，rabbitmq镜像模式集群搭建完成，接下来-我们配置haproxy-keepalived-实现高可用和负载均衡" class="headerlink" title="至此，rabbitmq镜像模式集群搭建完成，接下来 我们配置haproxy+keepalived 实现高可用和负载均衡"></a>至此，rabbitmq镜像模式集群搭建完成，接下来 我们配置haproxy+keepalived 实现高可用和负载均衡</h4><h4 id="2-配置haproxy负载代理"><a href="#2-配置haproxy负载代理" class="headerlink" title="2 配置haproxy负载代理"></a>2 配置haproxy负载代理</h4><blockquote>
<p>环境：两台 centos7<br>192.168.9.153  192.168.9.154</p>
</blockquote>
<p>1.在两台机器上安装haproxy 我们采用yum安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install haproxy</span><br></pre></td></tr></table></figure></p>
<p>2.修改配置文件（两台服务器相同的操作）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/haproxy/haproxy.cfg</span><br></pre></td></tr></table></figure></p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Example configuration for a possible web application.  See the</span></span><br><span class="line"><span class="comment"># full configuration options online.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   http://haproxy.1wt.eu/download/1.4/doc/configuration.txt</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Global settings</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line">global</span><br><span class="line">    <span class="comment"># to have these messages end up in /var/log/haproxy.log you will</span></span><br><span class="line">    <span class="comment"># need to:</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 1) configure syslog to accept network log events.  This is done</span></span><br><span class="line">    <span class="comment">#    by adding the '-r' option to the SYSLOGD_OPTIONS in</span></span><br><span class="line">    <span class="comment">#    /etc/sysconfig/syslog</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 2) configure local2 events to go to the /var/log/haproxy.log</span></span><br><span class="line">    <span class="comment">#   file. A line like the following can be added to</span></span><br><span class="line">    <span class="comment">#   /etc/sysconfig/syslog</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#    local2.*                       /var/log/haproxy.log</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 local2</span><br><span class="line"></span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">    <span class="comment"># turn on stats unix socket</span></span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># common defaults that all the 'listen' and 'backend' sections will</span></span><br><span class="line"><span class="comment"># use if not designated in their block</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    <span class="built_in">log</span>                     global</span><br><span class="line">    <span class="comment">#option                  httplog</span></span><br><span class="line">    option                  dontlognull</span><br><span class="line">    <span class="comment">#option http-server-close</span></span><br><span class="line">    <span class="comment">#option forwardfor       except 127.0.0.0/8</span></span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    <span class="comment">#timeout http-request    10s</span></span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    <span class="comment">#timeout http-keep-alive 10s</span></span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># main frontend which proxys to the backends</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line">frontend  main *:5000</span><br><span class="line">    acl url_static       path_beg       -i /static /images /javascript /stylesheets</span><br><span class="line">    acl url_static       path_end       -i .jpg .gif .png .css .js</span><br><span class="line"></span><br><span class="line">    use_backend static          <span class="keyword">if</span> url_static</span><br><span class="line">    default_backend             app</span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># static backend for serving up images, stylesheets and such</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line">backend static</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      static 127.0.0.1:4331 check</span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># round robin balancing between the various backends</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line">backend app</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server  app1 127.0.0.1:5001 check</span><br><span class="line">    server  app2 127.0.0.1:5002 check</span><br><span class="line">    server  app3 127.0.0.1:5003 check</span><br><span class="line">    server  app4 127.0.0.1:5004 check</span><br><span class="line"></span><br><span class="line"><span class="comment">########打开 haproxy的检测界面########</span></span><br><span class="line"></span><br><span class="line">listen status</span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0:9188</span><br><span class="line">mode http</span><br><span class="line">stats <span class="built_in">enable</span></span><br><span class="line">stats refresh 30s</span><br><span class="line">stats uri /stats                     <span class="comment">#设置haproxy监控地址为http://localhost:9188/stats</span></span><br><span class="line">stats auth admin:123456              <span class="comment">#添加用户名密码认证</span></span><br><span class="line">stats realm (Haproxy\ statistic)</span><br><span class="line">stats admin <span class="keyword">if</span> TRUE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######################监听rabbitmq的web操作页面############################</span></span><br><span class="line">listen rabbitmq_admin</span><br><span class="line">    <span class="built_in">bind</span> 0.0.0.0:15672</span><br><span class="line">    server rabbitmq1 192.168.9.106:15672</span><br><span class="line">    server rabbitmq2 192.168.9.147:15672</span><br><span class="line">    server rabbitmq3 192.168.9.150:15672</span><br><span class="line"><span class="comment">#######################监听rabbimq_cluster #################################</span></span><br><span class="line">listen rabbitmq_cluster</span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0:5672</span><br><span class="line">mode tcp</span><br><span class="line">balance roundrobin                   <span class="comment">#负载均衡算法（#banlance roundrobin 轮询，balance source 保存session值，支持static-rr，leastconn，first，uri等参数）</span></span><br><span class="line">server rabbitmq1 192.168.9.106:5672 check inter 5000 rise 2 fall 2  <span class="comment">#check inter 2000 是检测心跳频率</span></span><br><span class="line">server rabbitmq2 192.168.9.147:5672 check inter 5000 rise 2 fall 2  <span class="comment">#rise 2是2次正确认为服务器可用</span></span><br><span class="line">server rabbitmq3 192.168.9.150:5672 check inter 5000 rise 2 fall 2  <span class="comment">#fall 2是2次失败认为服务器不可用</span></span><br></pre></td></tr></table></figure>
<p>3.将haproxy启动并且加入开机自启<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start haproxy</span><br><span class="line">systemctl <span class="built_in">enable</span> haproxy</span><br></pre></td></tr></table></figure></p>
<p>4.浏览器登录haproxy监测页面<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.9.153:9188/stats</span><br><span class="line">http://192.168.9.154:9188/stats</span><br><span class="line">账号密码  admin 123456</span><br></pre></td></tr></table></figure></p>
<p>5.浏览器登录rabbitmq 看是否代理成功<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.9.153:15672</span><br><span class="line">http://192.168.9.154:15672</span><br></pre></td></tr></table></figure></p>
<h4 id="3-配置keepalived"><a href="#3-配置keepalived" class="headerlink" title="3.配置keepalived"></a>3.配置keepalived</h4><p>1.在两台机器上安装keepalived<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#9.153 9.154上都安装</span></span><br><span class="line">yum -y install keepalived</span><br><span class="line">systemctl <span class="built_in">enable</span> keepalived</span><br></pre></td></tr></table></figure></p>
<p>2.修改/etc/keepalived/keepalived.conf配置文件，主机和备机稍有不同,已经在配置文件中声明,请详细阅读！</p>
<p>下面是主机的配置文件（9.153）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"><span class="comment"># 全局配置，配置收件人</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;               <span class="comment">##通知机制，收件人</span></span><br><span class="line">     Lcj950721@163.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from keepalived@domain.com <span class="comment">####发件人</span></span><br><span class="line">   smtp_server 192.168.9.153                     <span class="comment">##发件服务器</span></span><br><span class="line">   smtp_connect_timeout 30                       <span class="comment">##服务器连接超时时间</span></span><br><span class="line">   router_id LVS_DEVEL                           <span class="comment">##路由器标志</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 集群资源监控，组合track_script进行</span></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">script <span class="string">"killall -0 haproxy"</span></span><br><span class="line">interval 2</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance HAPROXY_HA &#123;</span><br><span class="line"><span class="comment"># 设置当前主机为主节点，如果是备用节点，则设置为BACKUP</span></span><br><span class="line"><span class="comment"># 备用节点时，设置为：</span></span><br><span class="line"><span class="comment"># state BACKUP</span></span><br><span class="line">state MASTER</span><br><span class="line"><span class="comment"># 指定HA监测网络接口，可以用ifconfig查看来决定设置哪一个</span></span><br><span class="line">interface eth0</span><br><span class="line"><span class="comment"># 虚拟路由标识，同一个VRRP实例要使用同一个标识，主备机</span></span><br><span class="line">virtual_router_id 66</span><br><span class="line"><span class="comment"># 因为当前环境中VRRP组播有问题，改为使用单播发送VRRP报文</span></span><br><span class="line"><span class="comment"># 这个地方需要关注，之前未做此设置，结果主备节点互相不能发现，因此主备节点都升级成了MASTER，并且绑定了VIP</span></span><br><span class="line"><span class="comment"># 主节点时，内容为：</span></span><br><span class="line">unicast_src_ip 192.168.9.153</span><br><span class="line"> unicast_peer &#123;</span><br><span class="line"> 192.168.9.154</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 备节点时，内容为：</span></span><br><span class="line"><span class="comment">#unicast_src_ip 192.168.1.102</span></span><br><span class="line"><span class="comment">#unicast_peer &#123;</span></span><br><span class="line"><span class="comment">#192.168.1.101</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"><span class="comment"># 设置优先级，确保主节点的优先级高过备用节点</span></span><br><span class="line"><span class="comment"># 主节点时，设置为：</span></span><br><span class="line">priority 100</span><br><span class="line"><span class="comment"># 备节点时，设置为：</span></span><br><span class="line"><span class="comment">#priority 80</span></span><br><span class="line"><span class="comment"># 用于设定主备节点间同步检查时间间隔</span></span><br><span class="line">advert_int 2</span><br><span class="line"><span class="comment"># 设置高可用集群中不抢占功能，在主机down后，从机接管，当主机重新恢复后，设置此功能，备机将继续提供服务，从而避免因切换导致的隐患</span></span><br><span class="line">nopreempt</span><br><span class="line"><span class="comment"># 设置主备节点间的通信验证类型及密码，同一个VRRP实例中需一致</span></span><br><span class="line">authentication &#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass towatt</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#下面这些脚本都是写入日志,需要的话可以打开,自己写一个shell</span></span><br><span class="line"><span class="comment"># 当keepalived切换状态到MASTER时，执行脚本</span></span><br><span class="line"><span class="comment">#notify_master "/etc/keepalived/master.sh"</span></span><br><span class="line"><span class="comment"># 当keepalived切换状态到BACKUP时，执行脚本</span></span><br><span class="line"><span class="comment">#notify_backup "/etc/keepalived/backup.sh"</span></span><br><span class="line"><span class="comment"># 当keepalived切换状态到FAULT时，执行脚本</span></span><br><span class="line"><span class="comment">#notify_fault "/etc/keepalived/fault.sh"</span></span><br><span class="line"><span class="comment"># 当keepalived切换状态到STOP时，执行脚本</span></span><br><span class="line"><span class="comment">#notify_fault "/etc/keepalived/stop.sh"</span></span><br><span class="line"><span class="comment"># 集群资源监控，组合vrrp_script进行</span></span><br><span class="line">track_script &#123;</span><br><span class="line">check_haproxy</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 设置虚拟IP地址，当keepalived状态切换为MASTER时，此IP会自动添加到系统中</span></span><br><span class="line"><span class="comment"># 当状态切换到BACKUP时，此IP会自动从系统中删除</span></span><br><span class="line"><span class="comment"># 可以通过命令ip add查看切换后的状态</span></span><br><span class="line">virtual_ipaddress &#123;</span><br><span class="line">192.168.9.158  <span class="comment">#虚拟ip配置完之后就用它访问</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3.启动keepalived服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start keepalived</span><br></pre></td></tr></table></figure></p>
<p>4.备机的配置文件如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"><span class="comment"># 全局配置，配置收件人</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;               <span class="comment">##通知机制，收件人</span></span><br><span class="line">     Lcj950721@163.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from keepalived@domain.com <span class="comment">####发件人</span></span><br><span class="line">   smtp_server 192.168.1.154                     <span class="comment">##发件服务器</span></span><br><span class="line">   smtp_connect_timeout 30                       <span class="comment">##服务器连接超时时间</span></span><br><span class="line">   router_id LVS_DEVEL                           <span class="comment">##路由器标志</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 集群资源监控，组合track_script进行</span></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">script <span class="string">"killall -0 haproxy"</span></span><br><span class="line">interval 2</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance HAPROXY_HA &#123;</span><br><span class="line"><span class="comment"># 设置当前主机为主节点，如果是备用节点，则设置为BACKUP</span></span><br><span class="line"><span class="comment"># 备用节点时，设置为：</span></span><br><span class="line"><span class="comment"># state BACKUP</span></span><br><span class="line">state BACKUP</span><br><span class="line"><span class="comment"># 指定HA监测网络接口，可以用ifconfig查看来决定设置哪一个</span></span><br><span class="line">interface eth0</span><br><span class="line"><span class="comment"># 虚拟路由标识，同一个VRRP实例要使用同一个标识，主备机</span></span><br><span class="line">virtual_router_id 66</span><br><span class="line"><span class="comment"># 因为当前环境中VRRP组播有问题，改为使用单播发送VRRP报文</span></span><br><span class="line"><span class="comment"># 这个地方需要关注，之前未做此设置，结果主备节点互相不能发现，因此主备节点都升级成了MASTER，并且绑定了VIP</span></span><br><span class="line"><span class="comment"># 主节点时，内容为：</span></span><br><span class="line"><span class="comment">#unicast_src_ip 192.168.1.101</span></span><br><span class="line"><span class="comment"># unicast_peer &#123;</span></span><br><span class="line"><span class="comment"># 192.168.1.102</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"><span class="comment"># 备节点时，内容为：</span></span><br><span class="line">unicast_src_ip 192.168.9.154</span><br><span class="line">unicast_peer &#123;</span><br><span class="line">192.168.9.153</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 设置优先级，确保主节点的优先级高过备用节点</span></span><br><span class="line"><span class="comment"># 主节点时，设置为：</span></span><br><span class="line"><span class="comment">#priority 100</span></span><br><span class="line"><span class="comment"># 备节点时，设置为：</span></span><br><span class="line">priority 80</span><br><span class="line"><span class="comment"># 用于设定主备节点间同步检查时间间隔</span></span><br><span class="line">advert_int 2</span><br><span class="line"><span class="comment"># 设置高可用集群中不抢占功能，在主机down后，从机接管，当主机重新恢复后，设置此功能，备机将继续提供服务，从而避免因切换导致的隐患</span></span><br><span class="line">nopreempt</span><br><span class="line"><span class="comment"># 设置主备节点间的通信验证类型及密码，同一个VRRP实例中需一致</span></span><br><span class="line">authentication &#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass towatt</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#下面这些脚本都是写入日志,需要的话可以打开,自己写一个shell</span></span><br><span class="line"><span class="comment"># 当keepalived切换状态到MASTER时，执行脚本</span></span><br><span class="line"><span class="comment">#notify_master "/etc/keepalived/master.sh"</span></span><br><span class="line"><span class="comment"># 当keepalived切换状态到BACKUP时，执行脚本</span></span><br><span class="line"><span class="comment">#notify_backup "/etc/keepalived/backup.sh"</span></span><br><span class="line"><span class="comment"># 当keepalived切换状态到FAULT时，执行脚本</span></span><br><span class="line"><span class="comment">#notify_fault "/etc/keepalived/fault.sh"</span></span><br><span class="line"><span class="comment"># 当keepalived切换状态到STOP时，执行脚本</span></span><br><span class="line"><span class="comment">#notify_fault "/etc/keepalived/stop.sh"</span></span><br><span class="line"><span class="comment"># 集群资源监控，组合vrrp_script进行</span></span><br><span class="line">track_script &#123;</span><br><span class="line">check_haproxy</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 设置虚拟IP地址，当keepalived状态切换为MASTER时，此IP会自动添加到系统中</span></span><br><span class="line"><span class="comment"># 当状态切换到BACKUP时，此IP会自动从系统中删除</span></span><br><span class="line"><span class="comment"># 可以通过命令ip add查看切换后的状态</span></span><br><span class="line">virtual_ipaddress &#123;</span><br><span class="line">192.168.9.158  <span class="comment">#虚拟ip配置完之后就用它访问</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>5.浏览器访问虚拟ip 192.168.9.158 查看是否ip漂移<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">浏览器访问：http://192.168.9.158:9188/stats</span><br><span class="line">           http://192.168.9.158:15672</span><br></pre></td></tr></table></figure></p>
<p>6.成功后，我们实验一下单点故障<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#随便停掉一台的keepalived</span></span><br><span class="line">  systemctl stop keepalived</span><br></pre></td></tr></table></figure></p>
</div><iframe src="/donate/?AliPayQR=null&amp;WeChatQR=/img/WeChatQR.png&amp;GitHub=null&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div class="tags"><a href="/tags/技术/">技术</a></div><div class="post-nav"><a class="next" href="/2019/01/18/mysql主从同步/">mysql主从同步</a></div><div id="lv-container" data-id="city" data-uid="MTAyMC80MTc2Ni8xODMxMg=="><script>(function(d, s) {
   var j, e = d.getElementsByTagName(s)[0];
   if (typeof LivereTower === 'function') { return; }
   j = d.createElement(s);
   j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
   j.async = true;
   e.parentNode.insertBefore(j, e);
})(document, 'script');
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/友人/">友人</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/技术/" style="font-size: 15px;">技术</a> <a href="/tags/生活/" style="font-size: 15px;">生活</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/03/22/rabbitmq集群-HA-keepalived/">rabbitmq集群+HA+keepalived</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/18/mysql主从同步/">mysql主从同步</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/24/ELK安装部署文档/">ELK安装部署文档</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/22/一个人在夜里想的太多/">一个人在夜里想的太多</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/21/故事的最后你还是说了拜拜/">故事的最后你还是说了拜拜</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/20/纸上得来终觉浅/">纸上得来终觉浅</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/20/随记/">随记</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">nice.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>